{% load static %}

<!--base template-->
{% block head_comment %}{% endblock %}
<!doctype html>
<html lang="en-ca"  data-bs-theme="{{preference_mode}}" >
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% block headblock %}{% endblock %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/css/ion.rangeSlider.min.css"/>
    <link rel="stylesheet" type="text/css" href="{% static 'budgetdb/style.css' %}">
    <link rel="shortcut icon" href="{% static 'budgetdb/favicon.ico' %}"/>        
    
    <title>{% block title %}The I'm not crazy, you're crazy! Budget{% endblock %}</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
        
</head>
<!--red for test environment
<body style="background-color:red">-->
    <body>
    {% csrf_token %}
    {% block navtools %}
    <nav class="navbar navbar-expand-lg fixed-top bg-body-tertiary">
        <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'budgetdb:home' %}">Budget</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        {% if user.is_authenticated %}
            {% if user.email_verified %}
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Config
                        </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="{% url 'budgetdb:list_accounthost' %}">Account Hosts</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_account_simple' %}">Accounts</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_accountcategory' %}">Account Categories</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_cat1' %}">Categories</a>                        
                            <a class="dropdown-item" href="{% url 'budgetdb:list_cat2' %}">Subcategories</a>                        
                            <a class="dropdown-item" href="{% url 'budgetdb:list_cattype' %}">Category Type</a>                        
                            <a class="dropdown-item" href="{% url 'budgetdb:list_vendor' %}">Vendors</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_be' %}">Recurring Events</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_joinedtransactions' %}">Joined Transactions</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_statement' %}">Statements</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_template' %}">Templates</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Transactions
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown" id="transaction_menu">
                            <a class="dropdown-item" href="{% url 'budgetdb:create_transaction' %}">* Create transaction *</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_transaction2' %}">All transaction</a>     
    <!--                        <a class="dropdown-item" href="{% url 'budgetdb:calendar_transaction' %}">Calendar</a>           removed, need to think about permissions       -->
                        </div>
                    </li>
        <!--            <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Transactions per categories
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown" id="categories_menu">
                        </div>
                    </li>  -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Accounts
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown" id="account_menu">
                            <a class="dropdown-item" href="{% url 'budgetdb:list_account_summary' %}">summary</a>
                            <div class="dropdown-divider"></div>
                        </div>
                        
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Bar Chart
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown" id="bar_chart_menu">
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Pie Chart
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown" id="pie_chart_menu">
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Timeline
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown" id="timeline_menu">
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Checks
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown" id="transaction_menu">
                            <a class="dropdown-item" href="{% url 'budgetdb:list_unverified_transaction' %}">Old Unverified</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_manual_transaction' %}">Manual</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_deleted_transaction' %}">Deleted</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_anormal_be' %}">Recurrent no transaction</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_anormal2_be' %}">Recurrent no unverified</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_anormal3_be' %}">Recurrent stops short of timeline</a>
                        </div>
                    </li>
                </ul>
                <ul class="navbar-nav nav-fill flex-grow-1">
                    <li class="nav-item">
                            <input id="input_range" type="text" class="js-range-slider flex-grow-1" name="my_range" value=""/>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            {{ user.get_short_name }}
                        </a>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown" >
                            <a class="dropdown-item" href="{% url 'budgetdb:update_preferences' %}">Preference</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:list_invitation' %}">Sharing</a>
                            <a class="dropdown-item" href="{% url 'budgetdb:password_update' %}">Change Password</a>
                            <a class="dropdown-item" href=#>
                            <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#instructionsModal">
                                Instructions
                              </button>
                            </a>
                            <a class="dropdown-item">
                                <form id="logout-form" method="post" action="{% url 'budgetdb:logout' %}">
                                    {% csrf_token %}
                                    <button type="submit">Log out</button>
                                </form>
                            </a>
                        </div>
                    </li>
                </ul>
            </div>
            {% else %}  <!-- authenticated but email unverified  -->
            <div class="collapse navbar-collapse justify-content-center" id="navbarSupportedContent">
                <ul class="navbar-nav ">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Please verify your email address</a>
                    </li>
                </ul>
            </div>
            <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
                <ul class="navbar-nav ">
                            <li class="nav-item active">
                            <a class="nav-link" href="{% url 'budgetdb:send_email_verification' %}?next={% url 'budgetdb:home' %}">Re-send verification email</a>
                    </li>
                </ul>
            </div>
            {% endif %}    
        {% else %}   <!-- not authenticated  -->
        <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
            <ul class="navbar-nav ">
                <li class="nav-item active">
                    <a class="nav-link" href="{% url 'budgetdb:login' %}?next={% url 'budgetdb:home' %}">Login</a>
                </li>
                <li class="nav-item active">
                        <a class="nav-link" href="{% url 'budgetdb:signup' %}?next={% url 'budgetdb:home' %}">Register</a>
                </li>
            </ul>
        </div>
        {% endif %}
    </nav>
    {% endblock %}
  <!-- Modal -->
  <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="instructionsModalLabel">Instructions</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-4">
                  <nav id="navbar-instructions" class="h-100 flex-column align-items-stretch pe-4 border-end">
                    <nav class="nav nav-pills flex-column">
                      <a class="nav-link" href="#item-1">Preferences</a>
                      <nav class="nav nav-pills flex-column">
                        <a class="nav-link ms-3 my-1" href="#item-1-1">Color Theme</a>
                        <a class="nav-link ms-3 my-1" href="#item-1-2">Timeline</a>
                        <a class="nav-link ms-3 my-1" href="#item-1-3">Currency</a>
                        <a class="nav-link ms-3 my-1" href="#item-1-4">Prefered Currency</a>
                      </nav>
                      <a class="nav-link" href="#item-2">Config</a>
                      <nav class="nav nav-pills flex-column">
                        <a class="nav-link ms-3 my-1" href="#item-2-1">Account Hosts</a>
                        <a class="nav-link ms-3 my-1" href="#item-2-2">Accounts</a>
                        <a class="nav-link ms-3 my-1" href="#item-2-3">Account Categories</a>
                        <a class="nav-link ms-3 my-1" href="#item-2-4">Category Type</a>
                        <a class="nav-link ms-3 my-1" href="#item-2-5">Categories</a>
                        <a class="nav-link ms-3 my-1" href="#item-2-6">Subcategories</a>
                        <a class="nav-link ms-3 my-1" href="#item-2-7">Vendors</a>
                        <a class="nav-link ms-3 my-1" href="#item-2-8">Templates</a>
                        <a class="nav-link ms-3 my-1" href="#item-2-9">Recurring Events</a>
                        <a class="nav-link ms-3 my-1" href="#item-2-10">Statements</a>
                      </nav>
                    </nav>
                  </nav>
                </div>
              
                <div class="col-8">
                  <div data-bs-spy="scroll" data-bs-target="#navbar-instructions" data-bs-smooth-scroll="true" class="scrollspy-example-2" tabindex="0">
                    <div id="item-1">
                      <h4>Preferences</h4>
                      <p>under your name on the right menu</p>
                    </div>
                    <div id="item-1-1">
                      <h5>Light or dark Mode</h5>
                      <p>...</p>
                    </div>
                    <div id="item-1-2">
                      <h5>Timeline</h5>
                      <p>Set your limits and the active period.  You can also set the active period using the sliders in the menu</p>
                    </div>
                    <div id="item-1-3">
                      <h5>Currency</h5>
                      <p>Set the currencies you want to see when working with transactions</p>
                    </div>
                    <div id="item-1-4">
                      <h5>Prefered Currency</h5>
                      <p>Select the your default value</p>
                    </div>
                    <div id="item-2">
                      <h5>Config</h5>
                      <p>...</p>
                    </div>
                    <div id="item-2-1">
                        <h5>Account Hosts</h5>
                        <p>Create hosts. Ex: you for cash, your bank for checking, your employer for pay and benefits</p>
                      </div>
                    <div id="item-2-2">
                        <h5>Accounts</h5>
                        <p>Create your accounts</p>
                    </div>
                    <div id="item-2-1">
                        <h5>Account Categories</h5>
                        <p>These categories are used for the timeline graph. You can create one for retirement account, investments, frequently used...</p>
                    </div>
                    <div id="item-2-1">
                        <h5>Categort types</h5>
                        <p>Qualifies categories and subcategories. Ex: revenue, expenses, savings</p>
                    </div>
                    <div id="item-2-1">
                        <h5>Categories</h5>
                        <p>Used with subcategories to qualify transactions</p>
                    </div>
                    <div id="item-2-1">
                        <h5>Vendors</h5>
                        <p>...</p>
                    </div>
                    <div id="item-2-1">
                        <h5>Templates</h5>
                        <p>Allows for transaction templates associated with vendors to speed up transaction creation. Ex: bagel shop, category:food subcategory:groceries source account:credit card</p>
                    </div>
                    <div id="item-2-1">
                        <h5>Categories</h5>
                        <p>Everything that repeats itself from yearly tax payment to coffee every workday.
                            Choose repetition pattern, use the checkboxes to block/allow times lots. You can put tuitions every month and remove the summer months.
                            All the check boxes apply all the time, regardless of the configured repetition pattern.
                            Once you save, individuals transactions will be created.
                            If you are modifying a recurring event, every unverified and "no receipt" transactions associated will be deleted and recreated.
                            If you change the repeat pattern, old verified transactions will stay but new transactions could look like duplicate. To avoid this, you can set the start of the repeat pattern to the point after your verifications are done, typically today.</p>
                    </div>
                    <div id="item-2-1">
                        <h5>Statements</h5>
                        <p>Designed to verify credit card statements</p>
                    </div>  
                  </div>
                </div>
              </div>
        </div>
      </div>
    </div>
  </div>


    <div class="container-md w-100" >
    {% block content %}
    {% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/860aa3fdee.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>
    
    {% if user.is_authenticated %}
    <script>

    var begin_interval;
    var end_interval;

    function parseDateIS (date) {
        var year = date.substr(0,4);
        var month = date.substr(5,2);
        month = month-1;
        var day = date.substr(8,2);
        return (dateToTS(new Date(year, month, day)))
    }
    
    function dateToTS(date) {
        return date.valueOf();
    }
    
    function tsToDate(ts) {
        var d = new Date(ts);
    
        return d.toLocaleDateString('fr-CA', {
            year: 'numeric',
            month: 'numeric',
            day: 'numeric'
        });
    }

    function onRangeUpdate(begin_interval, end_interval){
    }


    function addA(baseURL, pk, label, attachTo) {
        var newA = document.createElement('a');
        baseURL=baseURL.replace(/12345/,pk.toString())
        newA.setAttribute('href',baseURL);
        newA.setAttribute('class','dropdown-item');
        newA.innerHTML = label;
        document.getElementById(attachTo).append(newA);
    }

    $(document).ready(function(){
        $.getJSON('{% url "budgetdb:cattype_list_json" %}', function(result){
            $.each(result, function(i, field){
                addA('{% url "budgetdb:cattype_pie" 12345 %}', field[0].pk, field[1].name, 'pie_chart_menu');
                addA('{% url "budgetdb:cattype_bar" 12345 %}', field[0].pk, field[1].name, 'bar_chart_menu');
            });
        });
    });

    $(document).ready(function(){
        $.getJSON('{% url "budgetdb:account_list_detailed_view_json" %}', function(result){
            $.each(result, function(i, field){
                addA('{% url "budgetdb:list_account_activity" 12345 %}', field[0].pk, field[1].name, 'account_menu');
            });
        });
    });

    $(document).ready(function(){
        $.getJSON('{% url "budgetdb:accountcat_view_list_json" %}', function(result){
            $.each(result, function(i, field){
                addA('{% url "budgetdb:timeline_chart" %}?ac=12345', field[0].pk, field[1].name, 'timeline_menu');
            });
        });
    });

    $(document).ready(function(){
            $.getJSON('{% url "budgetdb:preferences_json" %}', function(result){
                min = parseDateIS(result.timeline_start);
                max = parseDateIS(result.timeline_stop);
                begin_interval = result.slider_start;
                from = parseDateIS(begin_interval);
                end_interval = result.slider_stop;
                to = parseDateIS(end_interval);
                $(".js-range-slider").ionRangeSlider({
                    type: "double",
                    skin: "big",
                    min: min,
                    max: max,
                    from: from,
                    to: to,
                    prettify: tsToDate,
                    onFinish: function (data) {
                        data = { 'begin_interval': data.from_pretty, 'end_interval': data.to_pretty, 'csrfmiddlewaretoken': '{{csrf_token}}'}
                        $.post('{% url "budgetdb:setinterval_json" %}', data );
                        onRangeUpdate(data.from_pretty, data.to_pretty)
                    }
                })
            });
        });


    </script>
    {% endif %}
    <script src="{% static 'js/jquery.bootstrap.modal.forms.js' %}"></script>
    <!--<script src="{% static 'js/jquery.bootstrap.modal.forms.min.js' %}"></script>-->
    {% block script %}{% endblock %}
  </body>
</html>
