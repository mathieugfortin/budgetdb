{% extends 'budgetdb/base.html' %}
{% block head_comment %}<!--account_transaction_list template-->{% endblock %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{title}} {% endblock %}
{% block headblock %}
    <link rel="stylesheet" type="text/css" href="{% static 'budgetdb/account_transactions_list.css' %}">
{% endblock %}

{% block content %}
    <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog mt-5" role="document">
            <div class="modal-content"></div>
        </div>
    </div>
    
        <div class="row align-items-center"> 
            <div class="col-1 text-start">   
                <button  type="button" title="Create another transaction for today" class="update-transaction btn btn-link btn-sm" data-form-url="{% url 'budgetdb:create_transaction_from_date_account_modal' pk %}" >
                    <span class="material-symbols-outlined">add_circle</span>
                </button>
            </div>
            <div class="col-10 text-center">
                <h3>{{ account_name }} 
                <a href="{% url 'budgetdb:year_report_account' pk year %}" class="btn btn-info btn-sm"  >
                    <span class="material-symbols-outlined">monitoring</span></a>
                {% if statements_exist %}
                <a href="{% url 'budgetdb:list_statement_per_account' pk %}" class="btn btn-info btn-sm"  >
                    <span class="material-symbols-outlined">cards_stack</span></a>
                {% endif %}
                </h3>
            </div>
            <div class="col-1 text-end">
                <button  type="button" title="Create audit for today" class="update-transaction btn btn-link btn-sm" data-form-url="{% url 'budgetdb:list_account_activity_create_audit_from_account' pk %}" >
                    <span class="material-symbols-outlined">add_circle</span>
                </button>
            </div>
        </div>
    
        {% if filter %}
        <div class="row mt-2">
            <div class="col-10 offset-2 text-center">
                <form action="" method="get" class="d-flex justify-content-center align-items-center gap-2">
                    {{ filter.form.as_p }}
                    <button type="submit" class="btn btn-primary btn-sm">Filter</button>
                </form>
            </div>
        </div>
        {% endif %}

        <div class="row mt-4">
            <div class="col-12">
                {% load render_table from django_tables2 %}
                {% render_table table %}
            </div>
        </div>
    
 
{% endblock %}

{% block script %}
    {% include "budgetdb/js_flip_accounts.html" %}
      <script type="text/javascript">
    (function($) {
        $(function() {
            // 1. DATA INITIALIZATION
            const allCat1s = {{ cat1_json|safe }};
            // HELPER FUNCTION TO HIDE SELECT2 AND SHOW SPAN
            function hideSelect2($select) {
                const $wrapper = $select.closest('.cat1-wrapper, .cat2-wrapper');
                const $container = $wrapper.find('.cat1-select-container, .cat2-select-container');
                const $span = $wrapper.find('.cat-display');

                $container.addClass('d-none');
                $span.removeClass('d-none');
                
                // Destroy select2 to keep the DOM clean
                if ($select.data('select2')) {
                    $select.select2('destroy');
                }
            }
            // 2. CAT1 SWAPPER (Click to Edit)
            $(document).on('click', '.cat1-wrapper .cat-display', function() {
                const $span = $(this);
                const $wrapper = $span.closest('.cat1-wrapper');
                const $container = $wrapper.find('.cat1-select-container');
                const txId = $wrapper.data('txid');
                const currentId = $wrapper.data('cat1-id');

                let selectHtml = `<select class="cat-select cat1-select form-select form-select-sm" data-txid="${txId}">`;
                selectHtml += `<option value="">---------</option>`;
                allCat1s.forEach(cat => {
                    const selected = (cat.id == currentId) ? 'selected' : '';
                    selectHtml += `<option value="${cat.id}" ${selected}>${cat.name}</option>`;
                });
                selectHtml += `</select>`;

                $container.html(selectHtml).removeClass('d-none');
                $span.addClass('d-none');

                const $newSelect = $container.find('select');
                $newSelect.select2({ width: '100%', minimumResultsForSearch: 10 });
                $newSelect.select2('open');

                // Hide when closed (clicked away or selected)
                $newSelect.on('select2:close', function() {
                    hideSelect2($(this));
                });
                // Initialize Select2 on the newly created element
                //const $newSelect = $container.find('select');
                //$newSelect.select2({
                //    width: '100%',
                //    minimumResultsForSearch: Infinity // Hides the search box for a cleaner look
                //});

                // The Magic Line: This forces the dropdown to open immediately
                //$newSelect.select2('open');
            });

            // 3. AJAX SAVING (Cat1)
            $(document).on('change', '.cat1-select', function() {
                const $select = $(this);
                const txId = $select.data('txid');
                const cat1Id = $select.val();
                const $wrapper = $select.closest('.cat1-wrapper');

                const selectedText = $select.find("option:selected").text();
                $wrapper.find('.cat-display').text(selectedText);
                $wrapper.data('cat1-id', cat1Id);
                $wrapper.attr('data-cat1-id', cat1Id); // Critical for Cat2 to "see" the update

                

                $.post('{% url "budgetdb:update_transaction_category" %}', {
                    'transaction_id': txId,
                    'cat_level': 1,
                    'category_id': cat1Id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                })
                .done(function() {
                    const $badge = $('#save-check-cat1' + txId);
                    $badge.addClass('show');
                    setTimeout(() => $badge.removeClass('show'), 1500);
                    // reset it cat2
                    const $cat2Wrapper = $select.closest('tr').find('.cat2-wrapper');
                    $cat2Wrapper.find('.cat-display').text('---------'); // Reset the text
                    $cat2Wrapper.data('cat2-id', '');                // Clear the ID data
                    $cat2Wrapper.attr('data-cat2-id', '');           // Clear the ID attribute
                    // 2. Trigger the  CSS Pulse
                    $cat2Display.addClass('pulse-warning');
                    setTimeout(() => {
                        $cat2Display.removeClass('pulse-warning');
                    }, 1500);
                })
                .fail(() => alert("Error saving Cat1!"));
            });

            // 4. CAT2 SWAPPER (Select2 Auto-Open)
            $(document).on('click', '.cat2-wrapper .cat-display', function() {
                const $span = $(this);
                const $wrapper = $span.closest('.cat2-wrapper');
                const $container = $wrapper.find('.cat2-select-container');
                const txId = $wrapper.data('txid');
                const currentCat2Id = $wrapper.data('cat2-id');
                
                // Find the Cat1 wrapper in the same row
                const $cat1Wrapper = $span.closest('tr').find(`.cat1-wrapper[data-txid="${txId}"]`);
                const cat1Id = $cat1Wrapper.attr('data-cat1-id') || $cat1Wrapper.data('cat1-id');

                if (!cat1Id || cat1Id === "") {
                    alert("Please select a Category (Cat1) first.");
                    return;
                }

                $.getJSON('{% url "budgetdb:get_cat2_options" %}', { 'cat1_id': cat1Id })
                    .done(function(data) {
                        let selectHtml = `<select class="cat-select cat2-select form-select form-select-sm" data-txid="${txId}">`;
                        selectHtml += `<option value="">---------</option>`;
                        $.each(data.options, function(i, item) {
                            const selected = (item.id == currentCat2Id) ? 'selected' : '';
                            selectHtml += `<option value="${item.id}" ${selected}>${item.name}</option>`;
                        });
                        selectHtml += `</select>`;

                        $container.html(selectHtml).removeClass('d-none');
                        $span.addClass('d-none');
                        const $newSelect = $container.find('select');
                        $newSelect.select2({ width: '100%', minimumResultsForSearch: 10 });
                        $newSelect.select2('open');

                        $newSelect.on('select2:close', function() {
                            hideSelect2($(this));
                        });
                    });
            });

            // 5. AJAX SAVING (Cat2)
            $(document).on('change', '.cat2-select', function() {
                const $select = $(this);
                const txId = $select.data('txid');
                const cat2Id = $select.val();
                const $wrapper = $select.closest('.cat2-wrapper');

                const selectedText = $select.find("option:selected").text();
                $wrapper.find('.cat-display').text(selectedText);
                $wrapper.data('cat2-id', cat2Id);

                $.post('{% url "budgetdb:update_transaction_category" %}', {
                    'transaction_id': txId,
                    'cat_level': 2,
                    'category_id': cat2Id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                })
                .done(function() {
                    const $badge = $('#save-check-cat2' + txId);
                    $badge.addClass('show');
                    setTimeout(() => $badge.removeClass('show'), 1500);
                })
                .fail(() => alert("Error saving Cat2!"));
            });

            // 6. BLUR LOGIC (Switch back to text when clicking away)
            $(document).on('blur', '.cat-select', function() {
                const $select = $(this);
                const $container = $select.closest('.cat1-select-container, .cat2-select-container');
                const $wrapper = $select.closest('.cat1-wrapper, .cat2-wrapper');
                
                $container.addClass('d-none');
                $wrapper.find('.cat-display').removeClass('d-none');
            });

            // 7. MODAL & SELECT2 LOGIC (Your existing code)
            $(".update-transaction").each(function () {
                $(this).modalForm({ formURL: $(this).data("form-url"), modalID: "#modal" });
            });

            $(document).on("shown.bs.modal", "#modal", function() {
                const $modal = $(this);
                $modal.find(".delete-transaction-btn").each(function () {
                    $(this).modalForm({ formURL: $(this).data("form-url"), isAsync: true, modalID: "#modal" });
                });
                $modal.find(".django-select2").each(function() {
                    const $el = $(this);
                    $el.select2({ dropdownParent: $modal, width: '100%', allowClear: true });
                });
                setTimeout(() => $('#id_amount_actual').focus(), 300);
            });

            $(document).on('select2:open', function() {
                setTimeout(() => {
                    const searchField = document.querySelector('.select2-search__field');
                    if (searchField) searchField.focus();
                }, 10);
            });
        });
    })(jQuery); 
</script>
    {% include "budgetdb/js_toggle_receipt_verify.html" %}

{% endblock %}