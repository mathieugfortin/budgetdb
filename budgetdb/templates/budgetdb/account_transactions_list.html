{% extends 'budgetdb/base.html' %}
{% block head_comment %}<!--account_transaction_list template-->{% endblock %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{title}} {% endblock %}
{% block headblock %}
    <link rel="stylesheet" type="text/css" href="{% static 'budgetdb/account_transactions_list.css' %}">
{% endblock %}

{% block content %}
    <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog mt-5" role="document">
            <div class="modal-content"></div>
        </div>
    </div>
    <div class="container">
        <div class="row no-gutters">
        <div class="col-1 text-start">
            <button  type="button" title="Create another transaction for today" class="update-transaction btn btn-link btn-sm" data-form-url="{% url 'budgetdb:create_transaction_from_date_account_modal' pk %}" >
                <span class="material-symbols-outlined">add_circle</span>
            </button>
        </div>
        <div class="col text-center">
            <h3>{{ account_name }} 
            <a href="{% url 'budgetdb:year_report_account' pk year %}" class="btn btn-info btn-sm"  >
                <span class="material-symbols-outlined">monitoring</span></a>
            {% if statements_exist %}
            <a href="{% url 'budgetdb:list_statement_per_account' pk %}" class="btn btn-info btn-sm"  >
                <span class="material-symbols-outlined">cards_stack</span></a>
            {% endif %}
            </h3>
        </div>
        <div class="col-1 text-end">
            <button  type="button" title="Create audit for today" class="update-transaction btn btn-link btn-sm" data-form-url="{% url 'budgetdb:list_account_activity_create_audit_from_account' pk %}" >
                <span class="material-symbols-outlined">add_circle</span>
            </button>
        </div>
        </div>
    </div>

    {% load render_table from django_tables2 %}
        
    {% if filter %}
        <form action="" method="get" class="form form-inline">
            {{ filter.form.as_p }}
        </form>
    {% endif %}

    {% render_table table %}

{% endblock %}

{% block script %}

</script>
    {% include "budgetdb/js_flip_accounts.html" %}
    <script type="text/javascript">
        (function($) {
            $(function() {
                // 1. Initialize the Modal Forms
                $(".update-transaction").each(function () {
                    $(this).modalForm({
                        formURL: $(this).data("form-url"),
                        modalID: "#modal" 
                    });
                });

                // 2. Combined Modal Logic (fires when the modal is visible)
                $(document).on("shown.bs.modal", "#modal", function() {
                    var $modal = $(this);

                    // Initialize all Select2 fields inside the modal
                    $modal.find(".django-select2").each(function() {
                        var $el = $(this);
                        $el.select2({
                            dropdownParent: $modal,
                            width: '100%', 
                            placeholder: $el.attr('data-placeholder') || "Select an option",
                            allowClear: true
                        });
                    });

                    // Set focus on the amount field after modal transition
                    setTimeout(function (){
                        $('#id_amount_actual').focus();
                    }, 300);
                });

                // 3. Fix for Select2 search field focus
                // This targets the search box that appears when you click a dropdown
                $(document).on('select2:open', function(e) {
                    setTimeout(function() {
                        // Focus the search field inside the dropdown
                        var searchField = document.querySelector('.select2-search__field');
                        if (searchField) {
                            searchField.focus();
                        }
                    }, 10); // Slight delay for rendering
                });
                
                $(document).on('change', '.cat1-select', function() {
                    var txId = $(this).data('txid');
                    var cat1Id = $(this).val();
                    var $cat2Select = $('#cat2-' + txId);

                    // 1. Save Cat1 choice via AJAX
                    $.post('{% url "budgetdb:update_transaction_category" %}', {
                        'transaction_id': txId,
                        'cat_level': 1,
                        'category_id': cat1Id,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    })
                    .done(function(response) {
                        // Find the specific checkmark for this transaction
                        var $badge = $('#save-check-cat1' + txId);
                        
                        // Show it
                        $badge.addClass('show');
                        
                        // Hide it again after 1.5 seconds
                        setTimeout(function() {
                            $badge.removeClass('show');
                        }, 1500);
                    })
                    .fail(function() {
                        alert("Error saving category!");
                    });

                    // 2. Fetch new Cat2 options
                    var cat2Url = '{% url "budgetdb:get_cat2_options" %}'; // Define it clearly
                    // debugger;
                    $.getJSON(cat2Url, { 'cat1_id': cat1Id })
                        .done(function(data) {
                            $cat2Select.empty().append('<option value="">---------</option>');
                            $.each(data.options, function(index, item) {
                                $cat2Select.append('<option value="' + item.id + '">' + item.name + '</option>');
                            });
                        })
                });

                $(document).on('change', '.cat2-select', function() {
                    var txId = $(this).data('txid');
                    var cat2Id = $(this).val();

                    // Save Cat2 choice via AJAX
                    $.post('{% url "budgetdb:update_transaction_category" %}', {
                        'transaction_id': txId,
                        'cat_level': 2,
                        'category_id': cat2Id,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    })
                    .done(function(response) {
                        // Find the specific checkmark for this transaction
                        var $badge = $('#save-check-cat2' + txId);
                        
                        // Show it
                        $badge.addClass('show');
                        
                        // Hide it again after 1.5 seconds
                        setTimeout(function() {
                            $badge.removeClass('show');
                        }, 1500);
                    })
                    .fail(function() {
                        alert("Error saving category!");
                    });
                });
            });
        })(jQuery); 
    </script>
    {% include "budgetdb/js_toggle_receipt_verify.html" %}

{% endblock %}